permissions:
  contents: write

name: Build and Release

on:
  workflow_dispatch:
    inputs:
      run-tests:
        description: 'Run tests'
        required: false
        type: boolean

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9 (for Velopack CLI)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Setup .NET 10 (for application build)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Extract Version from csproj
        id: extract_version
        shell: pwsh
        run: |
          [xml]$csproj = Get-Content ./IconSwapperGui.UI/IconSwapperGui.UI.csproj
          $version = $csproj.Project.PropertyGroup.Version
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        shell: pwsh
        run: |
          # Get the latest tag (if exists)
          $latestTag = git describe --tags --abbrev=0 2>$null
          
          if ([string]::IsNullOrEmpty($latestTag)) {
            # First release - get all commits
            $commits = git log --pretty=format:"- %s (%h)"
            $notes = "## ðŸŽ‰ Initial Release`n`n### Changes`n$commits"
          } else {
            # Subsequent releases - get commits since last tag
            $commits = git log "$latestTag..HEAD" --pretty=format:"- %s (%h)"
            $notes = "## What's Changed`n`n$commits"
          }
          
          # Save to output using proper multiline format
          "notes<<EOF" >> $env:GITHUB_OUTPUT
          $notes >> $env:GITHUB_OUTPUT
          "EOF" >> $env:GITHUB_OUTPUT

      - name: Restore dependencies
        run: dotnet restore "./IconSwapperGui.sln"

      - name: Publish application
        run: |
          dotnet publish "./IconSwapperGui.UI/IconSwapperGui.UI.csproj" -c Release -o publish -r win-x64 --self-contained false

      - name: Create Velopack Release
        shell: pwsh
        run: |
          dotnet tool install -g vpk
          try {
            vpk download github --repoUrl https://github.com/aj-phillips/IconSwapperGui --token ${{ secrets.GITHUB_TOKEN }}
          } catch {
            Write-Host "No previous releases found (expected for first release)"
          }
          vpk pack -u IconSwapperGui -v ${{ steps.extract_version.outputs.version }} -p publish -e IconSwapperGui.exe
          vpk upload github --repoUrl https://github.com/aj-phillips/IconSwapperGui --publish --releaseName "IconSwapperGui v${{ steps.extract_version.outputs.version }}" --tag v${{ steps.extract_version.outputs.version }} --releaseNotes "${{ steps.release_notes.outputs.notes }}" --token ${{ secrets.GITHUB_TOKEN }}
