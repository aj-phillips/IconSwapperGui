permissions:
  contents: write

name: Build and Release

on:
  workflow_dispatch:
    inputs:
      run-tests:
        description: 'Run tests'
        required: false
        type: boolean

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9 (for Velopack CLI)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Setup .NET 10 (for application build)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Extract Version from csproj
        id: extract_version
        shell: bash
        run: |
          version=$(grep -oP '<Version>\K[^<]+' ./IconSwapperGui.UI/IconSwapperGui.UI.csproj)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        shell: bash
        run: |
          # Get the latest tag (if exists)
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$latest_tag" ]; then
            # First release - get all commits
            echo "## ðŸŽ‰ Initial Release" > release_notes.md
            echo "" >> release_notes.md
            echo "### Changes" >> release_notes.md
            git log --pretty=format:"- %s (%h)" >> release_notes.md
          else
            # Subsequent releases - get commits since last tag
            echo "## What's Changed" > release_notes.md
            echo "" >> release_notes.md
            git log ${latest_tag}..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
          fi
          
          # Convert to single line for command line usage (escape newlines)
          notes=$(cat release_notes.md | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Restore dependencies
        run: dotnet restore "./IconSwapperGui.sln"

      - name: Publish application
        run: |
          dotnet publish "./IconSwapperGui.UI/IconSwapperGui.UI.csproj" -c Release -o publish -r win-x64 --self-contained false

      - name: Create Velopack Release
        shell: bash
        run: |
          dotnet tool install -g vpk
          vpk download github --repoUrl https://github.com/aj-phillips/IconSwapperGui --token ${{ secrets.GITHUB_TOKEN }} || echo "No previous releases found (expected for first release)"
          vpk pack -u IconSwapperGui -v ${{ steps.extract_version.outputs.version }} -p publish -e IconSwapperGui.exe
          vpk upload github --repoUrl https://github.com/aj-phillips/IconSwapperGui --publish --releaseName "IconSwapperGui v${{ steps.extract_version.outputs.version }}" --tag v${{ steps.extract_version.outputs.version }} --releaseNotes "${{ steps.release_notes.outputs.notes }}" --token ${{ secrets.GITHUB_TOKEN }}
